#jinja2: trim_blocks:False
# This file was generated by StackHead. Do not modify it.

{% for service in app_config.container.services %}
data "docker_registry_image" "stackhead-{{ project_name }}-{{ service.name }}" {
  provider = docker.{{ project_name }}
  name = "{{ service.image }}"
}

resource "docker_image" "stackhead-{{ project_name }}-{{ service.name }}" {
  provider = docker.{{ project_name }}
  name          = data.docker_registry_image.stackhead-{{ project_name }}-{{ service.name }}.name
  pull_triggers = [data.docker_registry_image.stackhead-{{ project_name }}-{{ service.name }}.sha256_digest]
  keep_locally = true
}

resource "docker_container" "stackhead-{{ project_name }}-{{ service.name }}" {
  provider = docker.{{ project_name }}
  image = docker_image.stackhead-{{ project_name }}-{{ service.name }}.latest
  name  = "stackhead-{{ project_name }}-{{ service.name }}"
  restart = "always"

{# Ensure volume directories have correct user (there was an issue with mariadb) #}
{%- for volume in service.volumes|default([]) %}

{%- if volume.type == "local" %}
    {%- set path = stackhead__containerdata_location_services|format(service.name, volume.src) %}
{%- elif volume.type == "custom" %}
    {%- set path = volume.src %}
{%- elif volume.type == "global" %}
    {%- set path = stackhead__containerdata_location_global|format(volume.src) %}
{%- endif %}

{%- if volume.user|d('') != '' and path|d('') != '' %}
  provisioner "local-exec" {
      command = "chown -R {{ volume.user }}:stackhead {{ path }}"
  }
{%- endif %}
{%- endfor %}

  {% if service.hooks is defined %}
  {% if service.hooks.execute_after_setup is defined %}
  provisioner "local-exec" {
      command = "docker cp -a {{ stackhead__containerhooks_location }}/afterSetup_{{ service.hooks.execute_after_setup|basename }} stackhead-{{ project_name }}-{{ service.name }}:/afterSetup_{{ service.hooks.execute_after_setup|basename }} && docker exec stackhead-{{ project_name }}-{{ service.name }} sh /afterSetup_{{ service.hooks.execute_after_setup|basename }}"
  }
  {% endif %}
  {% endif %}

  networks_advanced {
    name = docker_network.stackhead-network-{{ project_name }}.name
    aliases = ["{{ service.name }}"]
  }

{%- if service.user is defined %}
  user = "{{ service.user }}"
{%- endif %}

{%- for domainConfig in app_config.domains if domainConfig.expose is defined %}
{%- for expose in domainConfig.expose if expose.internal_port is defined and expose.service == service.name %}
  ports {
    internal = {{ expose.internal_port }}
  }
{%- endfor %}
{%- endfor %}
{%- if service.environment is defined %}
  env = [{% for envName, envVal in service.environment.items() %}{% if not loop.first %},{% endif %}"{{ envName }}={{ envVal|getstackhead.stackhead.TFreplace(project_name, 'docker_container') }}"{% endfor %}]
{%- endif %}

{%- for volume in service.volumes|default([]) %}
  volumes {
  {%- if volume.type == "custom" %}
    host_path = "{{ volume.src }}"
    container_path = "{{ volume.dest }}"
  {%- else %}
  {%- set sanitizedSrc = volume.src | regex_replace('[^\w]', '_') %}
    volume_name = docker_volume.{{ volume.type }}-{{ project_name }}{% if volume.type == "local" %}-{{ service.name }}{% endif %}-{{ sanitizedSrc }}.name
    container_path = "{{ volume.dest }}"
  {%- endif %}
  {% if volume.mode is defined and volume.mode == 'ro' %}  read_only = true{% endif %}
  }
{%- endfor %}
{%- for service in service.volumes_from|default([]) %}
  volumes {
    from_container = docker_container.stackhead-{{ project_name }}-{{ service | regex_replace(':ro$','') }}.name
    {% if service.endswith(':ro') %}read_only = true{% endif %}
  }
{%- endfor %}
  depends_on = [{%- for service in service.volumes_from|default([]) %}docker_container.stackhead-{{ project_name }}-{{ service | regex_replace(':ro$','') }}{% if not loop.first %},{% endif %}{%- endfor %}]
}
{% endfor %}

{%- set globalVolumeKeys = [] %}
{%- for service in app_config.container.services if service.volumes is defined %}
  {%- for volume in service.volumes %}
    {%- set src = volume.src|default('') %}
    {%- set sanitizedSrc = src | regex_replace('[^\w]', '_') %}
    {%- if volume.type == "local" %}
resource "docker_volume" "local-{{ project_name }}-{{ service.name }}-{{ sanitizedSrc }}" {
  provider = docker.{{ project_name }}
  name = "local-{{ project_name }}-{{ service.name }}-{{ sanitizedSrc }}"
  driver_opts = {
    type: "none",
    device: "{{ stackhead__containerdata_location_services|format(service.name, src) }}",
    o: "bind"
  }
}
    {%- elif volume.type == "global" and sanitizedSrc not in globalVolumeKeys %}
resource "docker_volume" "global-{{ project_name }}-{{ sanitizedSrc }}" {
  provider = docker.{{ project_name }}
  name = "global-{{ project_name }}-{{ sanitizedSrc }}"
  driver_opts = {
    type: "none",
    device: "{{ stackhead__containerdata_location_global|format(src) }}",
    o: "bind"
  }
}
      {%- set _ = globalVolumeKeys.append( sanitizedSrc ) %}
    {%- endif %}
  {%- endfor %}
{%- endfor %}

resource "docker_network" "stackhead-network-{{ project_name }}" {
  provider = docker.{{ project_name }}
  name = "stackhead-network-{{ project_name }}"
}
